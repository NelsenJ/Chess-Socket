<!DOCTYPE html>
<html>
<head>
    <title>Game Room</title>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
      .wrap { max-width: 1100px; margin: 16px auto; color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
      .top { display:flex; align-items:center; justify-content:space-between; margin-bottom: 12px; }
      .status { font-size: 14px; color: var(--muted); }
      .board { width: 360px; height: 360px; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); border: 2px solid var(--border); border-radius: 12px; overflow: hidden; background: #0b1224; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
      .cell { display:flex; align-items:center; justify-content:center; font-size: 64px; cursor: pointer; color: #e5e7eb; background: #0e1426; border: 1px solid var(--border); }
      .cell:hover { background: #121a31; }
      .panel { margin-top: 10px; color: var(--text); display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
      .btn { padding: 10px 12px; background: linear-gradient(135deg, var(--primary), #34d399); color:#064e3b; border:none; border-radius: 10px; cursor: pointer; font-weight:700; }
      .btn:disabled { background: #374151; color:#9ca3af; cursor:not-allowed; }
      .btn.secondary { background: #1f2937; color: #e5e7eb; }
      .btn.danger { background: #dc2626; color: #fef2f2; }
      .btn.success { background: #059669; color: #f0fdf4; }
      .notice { margin-left: auto; color: var(--muted); }
      .rematch-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; }
      .rematch-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card); padding: 24px; border-radius: 12px; border: 1px solid var(--border); text-align: center; min-width: 300px; }
      .rematch-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 16px; }
      .player-info { display: flex; gap: 16px; margin-bottom: 16px; }
      .player-card { background: #0e1426; padding: 12px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
      .player-card.current { border-color: #34d399; background: #064e3b; }
      .flash-message { padding: 12px; border-radius: 8px; margin-bottom: 16px; position: fixed; top: 20px; right: 20px; z-index: 1001; max-width: 300px; }
      .flash-message.error { background: #7f1d1d; color: #fca5a5; border: 1px solid #dc2626; }
      .flash-message.success { background: #065f46; color: #6ee7b7; border: 1px solid #059669; }
      .flash-message.info { background: #1e40af; color: #93c5fd; border: 1px solid #2563eb; }
    </style>
    
</head>
<body>
<div class="wrap">
  <div class="top">
    <div class="status">Room: <strong>{{ room_id }}</strong> â€¢ User: <strong>{{ username }}</strong></div>
    <div class="status" id="status">Connecting...</div>
  </div>
  
  <div class="player-info" id="playerInfo" style="display: none;">
    <div class="player-card" id="playerX">
      <div style="font-size: 24px; font-weight: bold; color: #34d399;">X</div>
      <div id="playerXName">-</div>
    </div>
    <div class="player-card" id="playerO">
      <div style="font-size: 24px; font-weight: bold; color: #fbbf24;">O</div>
      <div id="playerOName">-</div>
    </div>
  </div>
  
  <div class="board" id="board"></div>
  
  <div class="panel">
    <button class="btn" id="btnRematch" style="display: none;">Request Rematch</button>
    <button class="btn danger" id="btnDissolve" style="display: none;">Dissolve Room</button>
    <button class="btn secondary" id="btnLeave">Leave Room</button>
    <span id="rematchInfo" class="notice"></span>
  </div>
</div>

<!-- Rematch Modal -->
<div class="rematch-modal" id="rematchModal">
  <div class="rematch-content">
    <h3>Rematch Request</h3>
    <p id="rematchMessage">Room creator wants to play again!</p>
    <div class="rematch-buttons">
      <button class="btn success" id="btnAcceptRematch">Accept</button>
      <button class="btn secondary" id="btnDeclineRematch">Decline</button>
    </div>
  </div>
</div>

<script>
const socket = io();
const roomId = "{{ room_id }}";
const username = "{{ username }}";

let myMark = null; // 'X' | 'O'
let mode = 'pvp';
let turn = 'X';
let board = Array(9).fill('');
let isRoomCreator = false;
let roomCreator = '';

const statusEl = document.getElementById('status');
const boardEl = document.getElementById('board');
const rematchInfo = document.getElementById('rematchInfo');
const playerInfo = document.getElementById('playerInfo');
const playerXName = document.getElementById('playerXName');
const playerOName = document.getElementById('playerOName');
const btnRematch = document.getElementById('btnRematch');
const btnDissolve = document.getElementById('btnDissolve');
const rematchModal = document.getElementById('rematchModal');
const rematchMessage = document.getElementById('rematchMessage');

function showFlashMessage(message, type = 'info') {
  const flash = document.createElement('div');
  flash.className = `flash-message ${type}`;
  flash.textContent = message;
  document.body.appendChild(flash);
  
  setTimeout(() => {
    flash.style.opacity = '0';
    flash.style.transition = 'opacity 0.3s ease';
    setTimeout(() => flash.remove(), 300);
  }, 3000);
}

function renderBoard(){
  boardEl.innerHTML = '';
  for (let i=0;i<9;i++){
    const div = document.createElement('div');
    div.className = 'cell';
    div.textContent = board[i] || '';
    div.addEventListener('click', () => onCell(i));
    boardEl.appendChild(div);
  }
}

function updateStatus(winner){
  if (winner === 'draw') { 
    statusEl.textContent = 'Game Draw!'; 
    return; 
  }
  if (winner === 'X' || winner === 'O') { 
    statusEl.textContent = `Winner: ${winner}`; 
    return; 
  }
  statusEl.textContent = `Turn: ${turn}` + (myMark ? ` | You: ${myMark}` : '');
}

function updatePlayerCards() {
  const playerXCard = document.getElementById('playerX');
  const playerOCard = document.getElementById('playerO');
  
  // Reset current player indicator
  playerXCard.classList.remove('current');
  playerOCard.classList.remove('current');
  
  // Highlight current turn
  if (turn === 'X') {
    playerXCard.classList.add('current');
  } else {
    playerOCard.classList.add('current');
  }
}

function onCell(i){
  if (!myMark) return;
  if (board[i]) return;
  if (turn !== myMark) return;
  socket.emit('ttt_move', { room_id: roomId, index: i });
}

function showRematchModal(requestedBy) {
  rematchMessage.textContent = `${requestedBy} wants to play again!`;
  rematchModal.style.display = 'block';
}

function hideRematchModal() {
  rematchModal.style.display = 'none';
}

// Socket event handlers
socket.emit('join_room', { room_id: roomId });

socket.on('ttt_init', (data) => {
  mode = data.mode || 'pvp';
  myMark = data.you || null;
  board = data.board || Array(9).fill('');
  turn = data.turn || 'X';
  isRoomCreator = data.is_creator || false;
  roomCreator = data.room_creator || '';
  
  renderBoard();
  updateStatus(data.winner || null);
  updatePlayerCards();
  
  // Show/hide buttons based on role
  if (isRoomCreator) {
    btnRematch.style.display = 'inline-block';
    btnDissolve.style.display = 'inline-block';
  } else {
    btnRematch.style.display = 'none';
    btnDissolve.style.display = 'none';
  }
  
  if (data.winner){
    rematchInfo.textContent = 'Game finished.';
  } else {
    rematchInfo.textContent = '';
  }
});

socket.on('players_update', (data) => {
  // Update player names
  if (data.players.X) {
    playerXName.textContent = data.players.X;
  }
  if (data.players.O) {
    playerOName.textContent = data.players.O;
  }
  
  // Show player info
  playerInfo.style.display = 'flex';
  
  // Update room creator info
  roomCreator = data.room_creator || '';
  isRoomCreator = username === roomCreator;
  
  // Show/hide buttons based on role
  if (isRoomCreator) {
    btnRematch.style.display = 'inline-block';
    btnDissolve.style.display = 'inline-block';
  } else {
    btnRematch.style.display = 'none';
    btnDissolve.style.display = 'none';
  }
});

socket.on('ttt_update', (d) => {
  board = d.board || board;
  turn = d.turn || turn;
  renderBoard();
  updateStatus(d.winner || null);
  updatePlayerCards();
  
  if (d.winner){
    rematchInfo.textContent = 'Game finished.';
  }
});

socket.on('rematch_requested', (data) => {
  if (!isRoomCreator) {
    showRematchModal(data.requested_by);
    rematchInfo.textContent = 'Rematch requested. Please respond.';
  }
});

socket.on('rematch_status', (d) => {
  const votes = d.votes || [];
  const pending = d.pending || [];
  rematchInfo.textContent = `Rematch votes: ${votes.join(', ')} | Pending: ${pending.join(', ')}`;
});

socket.on('rematch_declined', (data) => {
  rematchInfo.textContent = `${data.declined_by} declined rematch.`;
  hideRematchModal();
});

socket.on('ttt_reset', (d) => {
  board = d.board || Array(9).fill('');
  turn = d.turn || 'X';
  renderBoard();
  updateStatus(null);
  updatePlayerCards();
  rematchInfo.textContent = 'Game reset! Good luck!';
  hideRematchModal();
});

socket.on('room_dissolved', () => {
  showFlashMessage('Room dissolved by creator', 'info');
  setTimeout(() => {
    window.location.href = '/dashboard';
  }, 2000);
});

socket.on('error', (e) => {
  showFlashMessage(e.message || 'Error occurred', 'error');
});

// Button event listeners
document.getElementById('btnLeave').addEventListener('click', () => {
  socket.emit('leave_room', { room_id: roomId });
  window.location.href = '/dashboard';
});

btnRematch.addEventListener('click', () => {
  if (!isRoomCreator) return;
  socket.emit('ttt_rematch_request', { room_id: roomId });
  rematchInfo.textContent = 'Rematch requested. Waiting for response...';
});

btnDissolve.addEventListener('click', () => {
  if (!isRoomCreator) return;
  if (confirm('Are you sure you want to dissolve this room?')){
    socket.emit('dissolve_room', { room_id: roomId });
  }
});

document.getElementById('btnAcceptRematch').addEventListener('click', () => {
  socket.emit('ttt_rematch_response', { 
    room_id: roomId, 
    response: 'accept' 
  });
  hideRematchModal();
  rematchInfo.textContent = 'Rematch accepted!';
});

document.getElementById('btnDeclineRematch').addEventListener('click', () => {
  socket.emit('ttt_rematch_response', { 
    room_id: roomId, 
    response: 'decline' 
  });
  hideRematchModal();
  rematchInfo.textContent = 'Rematch declined.';
});

// Close modal when clicking outside
rematchModal.addEventListener('click', (e) => {
  if (e.target === rematchModal) {
    hideRematchModal();
  }
});
</script>
</body>
</html>
