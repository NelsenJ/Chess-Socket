<!DOCTYPE html>
<html>
<head>
    <title>Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
      .layout { display:grid; grid-template-columns: 1fr 1fr; gap: 24px; max-width: 1100px; margin: 0 auto; }
      .card { background: var(--card); padding:18px; border-radius:14px; border:1px solid var(--border); box-shadow: 0 10px 30px rgba(0,0,0,.25); text-align:left; }
      .rooms-list { list-style:none; padding:0; margin:0; }
      .rooms-list li { display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid var(--border); border-radius:12px; margin-bottom:10px; background:#0b1224; }
      .btn { padding:10px 12px; border-radius:10px; }
      .btn.secondary { background:#1f2937; }
      .field { width:100%; padding:12px; border:1px solid var(--border); border-radius:10px; background:#0e1426; color:var(--text); }
      .row { display:flex; gap:10px; }
      .room-meta { display:flex; gap:8px; margin-top:4px; }
      .tag { padding:4px 8px; border-radius:6px; font-size:12px; font-weight:500; }
      .tag.green { background:#065f46; color:#6ee7b7; }
      .tag.purple { background:#5b21b6; color:#c4b5fd; }
      .tag.blue { background:#1e40af; color:#93c5fd; }
      .tag.orange { background:#92400e; color:#fbbf24; }
      .room-info { flex:1; }
      .room-actions { display:flex; gap:8px; align-items:center; }
      .flash-message { padding:12px; border-radius:8px; margin-bottom:16px; }
      .flash-message.error { background:#7f1d1d; color:#fca5a5; border:1px solid #dc2626; }
      .flash-message.success { background:#065f46; color:#6ee7b7; border:1px solid #059669; }
      .flash-message.info { background:#1e40af; color:#93c5fd; border:1px solid #2563eb; }
    </style>
</head>
<body>
<div class="nav">
  <a class="brand" href="/">
    <div class="logo"></div>
    <span>TicTacToe Online</span>
  </a>
  <div class="right">
    <span class="chip">Hi, {{ session['username'] }}</span>
    <a class="btn secondary" href="{{ url_for('logout') }}">Logout</a>
  </div>
</div>

<div class="layout">
  <div class="card">
    <h3>Create Room</h3>
    <form method="POST">
      <input class="field" type="text" name="room_name" placeholder="Room Name" required>
      <div class="row">
        <select class="field" name="room_type" id="room_type">
          <option value="public">Public</option>
          <option value="private">Private</option>
        </select>
        <select class="field" name="room_mode" id="room_mode">
          <option value="pvp">PvP</option>
          <option value="bot">Vs Computer</option>
        </select>
      </div>
      <input class="field" type="password" name="password" id="password_field" placeholder="Password (for private)" style="display:none;">
      <button class="btn" type="submit">Create Room</button>
    </form>
    <p class="muted" style="margin:8px 0 0">Max 2 players. In Vs Computer mode, you play as X.</p>
  </div>

  <div class="card">
    <h3>Available Rooms</h3>
    <ul class="rooms-list" id="roomsList">
      {% for r in rooms %}
      <li data-room-id="{{ r['id'] }}">
        <div class="room-info">
          <div><strong>{{ r['name'] }}</strong></div>
          <div class="room-meta">
            <span class="tag {{ 'green' if r['type']=='public' else 'purple' }}">{{ r['type'] | capitalize }}</span>
            <span class="tag blue">{{ r['mode'] | upper }}</span>
            <span class="tag orange">Players: {{ r['players'] }}</span>
            <span class="tag">By: {{ r['created_by'] }}</span>
          </div>
        </div>
        <div class="room-actions">
          {% if r['type'] == 'public' %}
            <a class="btn" href="{{ url_for('game', room_id=r['id']) }}">Join</a>
          {% else %}
            {% if r['created_by'] == session['username'] %}
              <!-- Room creator can join directly -->
              <a class="btn" href="{{ url_for('game', room_id=r['id']) }}">Join (Your Room)</a>
            {% else %}
              <!-- Other users need password -->
              <form action="{{ url_for('game', room_id=r['id']) }}" method="GET" class="row" style="align-items:center;">
                <input class="field" style="max-width:160px;" type="password" name="password" placeholder="Room Password" required>
                <button class="btn" type="submit">Join</button>
              </form>
            {% endif %}
          {% endif %}
        </div>
      </li>
      {% endfor %}
    </ul>
    <div id="noRooms" style="display:none; text-align:center; padding:20px; color:var(--muted);">
      No rooms available. Create one to get started!
    </div>
  </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash-message {{ category }}" id="flash-{{ loop.index }}">
        {{ message }}
        <button onclick="this.parentElement.remove()" style="float:right; background:none; border:none; color:inherit; cursor:pointer;">Ã—</button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<script>
const socket = io();
const roomsList = document.getElementById('roomsList');
const noRooms = document.getElementById('noRooms');

// Auto-hide flash messages after 5 seconds
setTimeout(() => {
  document.querySelectorAll('.flash-message').forEach(msg => {
    msg.style.opacity = '0';
    setTimeout(() => msg.remove(), 300);
  });
}, 5000);

// Update room list in realtime
function updateRoomList() {
  const rooms = Array.from(roomsList.children);
  if (rooms.length === 0) {
    noRooms.style.display = 'block';
  } else {
    noRooms.style.display = 'none';
  }
}

// Handle new room created
socket.on('room_created', (data) => {
  const room = data.room;
  const currentUsername = '{{ session.get("username", "") }}';
  const isCreator = room.created_by === currentUsername;
  
  const li = document.createElement('li');
  li.setAttribute('data-room-id', room.id);
  li.innerHTML = `
    <div class="room-info">
      <div><strong>${room.name}</strong></div>
      <div class="room-meta">
        <span class="tag ${room.type === 'public' ? 'green' : 'purple'}">${room.type.charAt(0).toUpperCase() + room.type.slice(1)}</span>
        <span class="tag blue">${room.mode.toUpperCase()}</span>
        <span class="tag orange">Players: ${room.players}</span>
        <span class="tag">By: ${room.created_by}</span>
      </div>
    </div>
    <div class="room-actions">
      ${room.type === 'public' 
        ? `<a class="btn" href="/game/${room.id}">Join</a>`
        : isCreator
          ? `<a class="btn" href="/game/${room.id}">Join (Your Room)</a>`
          : `<form action="/game/${room.id}" method="GET" class="row" style="align-items:center;">
              <input class="field" style="max-width:160px;" type="password" name="password" placeholder="Room Password" required>
              <button class="btn" type="submit">Join</button>
             </form>`
      }
    </div>
  `;
  
  // Add with animation
  li.style.opacity = '0';
  li.style.transform = 'translateY(-20px)';
  roomsList.insertBefore(li, roomsList.firstChild);
  
  setTimeout(() => {
    li.style.transition = 'all 0.3s ease';
    li.style.opacity = '1';
    li.style.transform = 'translateY(0)';
  }, 10);
  
  updateRoomList();
});

// Handle room updated (player count)
socket.on('room_updated', (data) => {
  const roomElement = document.querySelector(`[data-room-id="${data.room_id}"]`);
  if (roomElement) {
    const playerCountElement = roomElement.querySelector('.tag.orange');
    if (playerCountElement) {
      playerCountElement.textContent = `Players: ${data.players}`;
    }
  }
});

// Handle room dissolved
socket.on('room_dissolved', (data) => {
  const roomElement = document.querySelector(`[data-room-id="${data.room_id}"]`);
  if (roomElement) {
    roomElement.style.transition = 'all 0.3s ease';
    roomElement.style.opacity = '0';
    roomElement.style.transform = 'translateX(100px)';
    setTimeout(() => {
      roomElement.remove();
      updateRoomList();
    }, 300);
  }
});

// Handle user connections
socket.on('user_connected', (data) => {
  console.log(`User connected: ${data.username}`);
});

socket.on('user_disconnected', (data) => {
  console.log(`User disconnected: ${data.username}`);
});

// Initialize room list state
updateRoomList();

document.getElementById("room_type").addEventListener("change", function(){
    let passField = document.getElementById("password_field");
    passField.style.display = (this.value === "private") ? "block" : "none";
});
</script>
</body>
</html>
